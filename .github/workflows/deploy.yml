name: ğŸ¬ Deploy Movie API to EC2

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“š Install dependencies
        run: |
          cd the-movie-api
          pnpm install --frozen-lockfile

      - name: ğŸ”¨ Build project
        run: |
          cd the-movie-api
          pnpm run build

      - name: ğŸ§ª Run tests
        run: |
          cd the-movie-api
          pnpm run test

  deploy:
    name: ğŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "ğŸ¬ Starting Movie API deployment..."

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd ~/TheMovieApi/the-movie-api

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ Pulling latest code..."
            git pull origin main

            # í™˜ê²½ë³€ìˆ˜ íŒŒì¼ í™•ì¸
            if [ ! -f .env ]; then
              echo "âŒ .env file not found!"
              exit 1
            fi

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down

            # ì´ë¯¸ì§€ ì •ë¦¬ (ì„ íƒì‚¬í•­)
            echo "ğŸ§¹ Cleaning up old images..."
            docker system prune -f

            # ìƒˆë¡œìš´ ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
            echo "ğŸ”¨ Building and starting containers..."
            docker-compose -f docker-compose.prod.yml up -d --build

            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… Checking container status..."
            docker-compose -f docker-compose.prod.yml ps

            # í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ Health check..."
            sleep 30
            curl -f http://localhost/health || echo "âš ï¸ Health check failed"

            echo "ğŸ‰ Deployment completed!"
